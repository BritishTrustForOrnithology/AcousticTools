#' Read and format BTO Acoustic Pipeline results file
#' 
#' @description
#' Read and prepare the standard results csv file generated by the Acoustic Pipeline.
#' 
#' @details
#' After reading the file certain date time fields are manipulated. For example, 
#' the recording start is inferred from the original file name. This and the 
#' detection date time are used to infer the offset in the file of each detection. 
#' For this users need to supply whether dates and times are separated by a hyphen 
#' (-) or underscore (_) to ensure correct creation of start times.
#' 
#' @param file_csv = string, the path and filename of the results csv file
#' @param date_time_sep = the character used to separate date and time in the 
#' original file names. Usually hyphen or underscore. Needed to correctly parse 
#' original filenames
#'
#' @return a dataframe. Note that offset is the time (seconds) of the start of 
#' the audio chunk in which the detection is located. Chunk length is determined 
#' by the classifier used. For example, an offset of 10, for a classifier that 
#' has a 4-second chunk length, means the detection is between 10 and 14 seconds 
#' into the file.
#' 
#' @export
#' 
read_pipeline_results <- function(file_csv, date_time_sep = '_') {
  
  if(!file.exists(file_csv)) stop('file_csv does not exist')
  if(!date_time_sep %in% c("-","_")) stop('date_time_sep must be either "_" or "-".')
  
  #read the results file
  results <- read.csv(file_csv, stringsAsFactors = FALSE, na.strings = c('NA','null'))
  
  #tidy file
  names(results) <- tolower(names(results))
  names(results) <- gsub(".","_", names(results), fixed = TRUE)
  
  #get offset positions of each detection
  #first find the date time component of the original file
  #pattern_underscore <- "(?:^|[^0-9])\\d{8}_\\d{6}[^0-9]"
  if(date_time_sep=='_') {
    results$file_start <- regmatches(results$original_file_name, regexpr("\\d{8}_\\d{6}", results$original_file_name))
    results$file_start <- as.POSIXct(results$file_start, format = "%Y%m%d_%H%M%S")
  }
  if(date_time_sep=='-') {
    results$file_start <- regmatches(results$original_file_name, regexpr("\\d{8}-\\d{6}", results$original_file_name))
    results$file_start <- as.POSIXct(results$file_start, format = "%Y%m%d-%H%M%S")
  }
  
  #next, get the detection times as a datetime object
  results$detection_start <- as.POSIXct(paste(results$actual_date, results$time, sep="_"), format = "%d/%m/%Y_%H:%M:%S")
  
  #finally, get the offset between start of file and start of detection in seconds
  results$offset <- as.numeric(difftime(results$detection_start, results$file_start, units = 'secs'))
  
  #check that none of the offsets are negative
  if(min(results$offset)<0) stop('Error - offsets cannot be zero. Check date times are being correctly interpreted')

  return(results)
}